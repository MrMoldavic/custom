<?php

if (!GETPOST('confirmmassaction', 'alpha') && $massaction != 'presend' && $massaction != 'confirm_presend') { $massaction = ''; }

if (!$error && ($massaction == 'expediate' || ($action == 'expediate' && $confirm == 'yes')) && $usercancreate)
{
	foreach ($toselect as $toselectid)
	{
		if (!confirmExpedition($toselectid, $exploitation->id, $user)) $error++;
	}
		$toselect = array();
		if (!$error) setEventMessages('Suivi mis à jour.', null);
		else setEventMessages('Une erreur est survenue lors de la mise à jour du suivi.', null, 'errors');
}

if (!$error && ($massaction == 'ship' || ($action == 'ship' && $confirm == 'yes')) && $usercancreate)
{
	foreach ($toselect as $toselectid)
	{
		if (!confirmShipping($toselectid, $exploitation->id, $user)) $error++;
	}
		$toselect = array();
		if (!$error) setEventMessages('Suivi mis à jour.', null);
		else setEventMessages('Une erreur est survenue lors de la mise à jour du suivi.', null, 'errors');
}

if (!$error && ($massaction == 'toreturn' || ($action == 'toreturn' && $confirm == 'yes')) && $usercancreate)
{
	foreach ($toselect as $toselectid)
	{
		if (!confirmToReturn($toselectid, $exploitation->id, $user)) $error++;
	}
		$toselect = array();
		if (!$error) setEventMessages('Suivi mis à jour.', null);
		else setEventMessages('Une erreur est survenue lors de la mise à jour du suivi.', null, 'errors');
}

if (!$error && ($massaction == 'return' || ($action == 'return' && $confirm == 'yes')) && $usercancreate)
{
	foreach ($toselect as $toselectid)
	{
		if (!confirmReturn($toselectid, $exploitation->id, $user)) $error++;
	}
		$toselect = array();
		if (!$error) setEventMessages('Suivi mis à jour.', null);
		else setEventMessages('Une erreur est survenue lors de la mise à jour du suivi.', null, 'errors');
}

if ($action == 'confirm_expedition') {
	$mat_id = GETPOST('mat_id', 'int');
	if (!$mat_id) exit;
	if (!confirmExpedition($mat_id, $exploitation->id, $user)) $error++;
	if (!$error) setEventMessages('Suivi mis à jour.', null);
	else setEventMessages('Une erreur est survenue lors de la mise à jour du suivi.', null, 'errors');
}

if ($action == 'confirm_shipping') {
	$mat_id = GETPOST('mat_id', 'int');
	if (!$mat_id) exit;
	if (!confirmShipping($mat_id, $exploitation->id, $user)) $error++;
	if (!$error) setEventMessages('Suivi mis à jour.', null);
	else setEventMessages('Une erreur est survenue lors de la mise à jour du suivi.', null, 'errors');
}

if ($action == 'confirm_toreturn') {
	$mat_id = GETPOST('mat_id', 'int');
	if (!$mat_id) exit;
	if (!confirmToReturn($mat_id, $exploitation->id, $user)) $error++;
	if (!$error) setEventMessages('Suivi mis à jour.', null);
	else setEventMessages('Une erreur est survenue lors de la mise à jour du suivi.', null, 'errors');
}

if ($action == 'confirm_return') {
	$mat_id = GETPOST('mat_id', 'int');
	$status = getMaterielSuiviStatus($mat_id);
	$is_replacement = isMaterielReplacement($mat_id);
	if (!$mat_id) exit;
	if (!confirmReturn($mat_id, $exploitation->id, $user)) $error++;
	if (!$error) {
		setEventMessages('Suivi mis à jour.', null);
		if ($status['is_exchange'] && $status ['fk_localisation'] == 2 && $status['etat_suivi'] == 2) setEventMessages('<br>Échange finalisé, le matériel a été sorti du kit.', null);
		if ($is_replacement && $status ['fk_localisation'] == 2 && $status['etat_suivi'] == 2) setEventMessages('<br>Entretien finalisé, le matériel de remplacement a été sorti du kit.', null);
		$exploitation->fetch($id); // Mise  à jour des données de l'exploitation

	}
	else setEventMessages('Une erreur est survenue lors de la mise à jour du suivi.', null, 'errors');
}

if ($action == 'confirm_cancel') {
	if (!$id) exit;
	if (!$exploitation->cancel($user)) $error++;
	if (!$error){
		setEventMessages('Exploitation annulée.', null);
		header('Location: '.DOL_URL_ROOT.'/custom/exploitation/list.php');
		exit;
	}
	else setEventMessages('Une erreur est survenue lors de l\'annulation de l\'exploitation.', null, 'errors');
}

if ($action == 'confirm_date_modify') {
	if (!$id) exit;
	if (strtotime($date_start) > strtotime($date_end))
	{
			setEventMessages('La date de fin d\'exploitation ne peut pas être antérieure au début de l\'exploitation.', null, 'errors');
	}
	else
	{
		if (!$exploitation->changeDate($date_start, $date_end, $user)) $error++;
		if (!$error){
			setEventMessages('Dates d\'exploitation modifiées avec succès', null);
		}
		else setEventMessages('Une erreur est survenue lors de la modification des dates d\'exploitation.', null, 'errors');
	}
}

if ($action == 'confirm_cloture') {
	if (!$id) exit;
	if (!$exploitation->cloture($user)) $error++;
	if (!$error){
		setEventMessages('Exploitation clôturée', null);
		header('Location: '.DOL_URL_ROOT.'/custom/exploitation/list.php');
		exit;
	}
	else setEventMessages('Une erreur est survenue lors de la clôture de l\'exploitation.', null, 'errors');
}

if ($action == 'confirm_exchange') {
	if (!$id) exit;
	if (!$fk_materiel) exit;
	$fk_materiel_echange = GETPOST('materiel_echange'.$fk_materiel, 'int'); // Récupération de l'id du materiel à faire entrer
	if (!$fk_materiel_echange) exit;

	if (!$exploitation->echange($fk_materiel, $fk_materiel_echange, $user)) $error++;
	if (!$error){
		$status = getMaterielSuiviStatus($fk_materiel);
		if (empty($status['fk_localisation']) && empty($status['etat_suivi'])) setEventMessages('Échange effectué, le matériel a été sorti du kit', null);
		else setEventMessages('Échange effectué, le matériel doit être retourné à l\'entrepôt', null);
	}
	else setEventMessages('Une erreur est survenue lors de l\'échange', null, 'errors');
	$action = 'view';
}
if ($action == 'confirm_add_materiel') {
	if (!$id) exit;
	if (!$fk_materiel_add) exit;
	if (!$fk_kit_add) exit;

	if (!$exploitation->addMateriel($fk_materiel_add, $fk_kit_add, $user)) $error++;
	if (!$error) setEventMessages('Le matériel a été ajouté à l\'exploitation', null);
	else setEventMessages('Une erreur est survenue lors de l\'ajout du matériel', null, 'errors');
	$action = 'view';
}
if ($action == 'confirm_entretien') {
	if (!$fk_materiel) exit;
	$urlparameters = '?materiel_id='.$fk_materiel;
	$urlparameters .= '&redirect_url='.urlencode(DOL_URL_ROOT.'/custom/exploitation/card.php?id='.$id);
	header('Location: '.DOL_URL_ROOT.'/custom/entretien/card.php'.$urlparameters);
}




if ($action == 'add' && $usercancreate)
{
    $error = 0;

    if (empty($exploitation_type_id))
    {
        setEventMessages($langs->trans('ErrorFieldRequired', 'Type de kit'), null, 'errors');
        $action = "create";
        $error++;
    }
    if (empty($fk_kit))
    {
        setEventMessages($langs->trans('ErrorFieldRequired', 'Kit(s) à inclure'), null, 'errors');
        $action = "create";
        $error++;
    }

    if (empty($date_start) || empty($date_end))
    {
        setEventMessages($langs->trans('ErrorFieldRequired', 'Date'), null, 'errors');
        $action = "create";
        $error++;
    }
		elseif (strtotime($date_start) > strtotime($date_end))
    {
        setEventMessages('La date de fin d\'exploitation ne peut pas être antérieure au début de l\'exploitation.', null, 'errors');
        $action = "create";
        $error++;
    }
    if (empty($fk_exploitant))
    {
        setEventMessages($langs->trans('ErrorFieldRequired', 'Exploitant'), null, 'errors');
        $action = "create";
        $error++;
    }
    if (!$error)
    {

        $exploitation->fk_type_exploitation         = $exploitation_type_id;
        $exploitation->fk_exploitant         = $fk_exploitant;
        $exploitation->date_debut         = $date_start;
        $exploitation->date_fin         = $date_end;
        $exploitation->notes          = $notes;
        $exploitation->fk_kit        = $fk_kit;
        if ($exploitation->create($user)) {
            setEventMessages('Exploitation ajouté avec succès !', null);
        }
        else {
            setEventMessages('Erreur lors de la création de l\'exploitation. Contactez l\'administrateur.<br>'.$exploitation->error, null, 'errors');
            $action = 'create';
            $error++;
        }
    }

    if (!$error) {
        header('Location: '.DOL_URL_ROOT.'/custom/exploitation/list.php');
        exit;
    }
}
