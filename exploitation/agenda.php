<?php
// ini_set('display_errors', '1');
// ini_set('display_startup_errors', '1');
// error_reporting(E_ALL);

// Load Dolibarr environment
@include "../../main.inc.php";

require_once DOL_DOCUMENT_ROOT.'/custom/materiel/class/materiel.class.php';
require_once DOL_DOCUMENT_ROOT.'/custom/materiel/class/kit.class.php';
require_once DOL_DOCUMENT_ROOT.'/custom/materiel/class/exploitation.class.php';
require_once DOL_DOCUMENT_ROOT.'/custom/materiel/class/formmateriel.class.php';
require_once DOL_DOCUMENT_ROOT.'/custom/materiel/class/formkit.class.php';
require_once DOL_DOCUMENT_ROOT.'/custom/materiel/class/formexploitation.class.php';

require_once DOL_DOCUMENT_ROOT.'/custom/materiel/core/lib/kit.lib.php';
require_once DOL_DOCUMENT_ROOT.'/custom/materiel/core/lib/functions.lib.php';
require_once DOL_DOCUMENT_ROOT.'/custom/materiel/core/lib/exploitation.lib.php';
require_once DOL_DOCUMENT_ROOT.'/custom/materiel/core/lib/materiel.lib.php';

require_once DOL_DOCUMENT_ROOT.'/product/class/html.formproduct.class.php';
require_once DOL_DOCUMENT_ROOT.'/core/lib/functions2.lib.php';
require_once DOL_DOCUMENT_ROOT.'/core/class/html.formfile.class.php';


// Load translation files required by the page
$langs->loadLangs(array("materiel@materiel"));

$socid = GETPOST('socid', 'int');
if (isset($user->socid) && $user->socid > 0)
{
	$action = '';
	$socid = $user->socid;
}

$usercanread = ($user->rights->materiel->read);
$usercancreate = ($user->rights->materiel->create);
$usercandelete = ($user->rights->materiel->delete);

if (!$usercanread) accessforbidden();

$max = 5;
$now = dol_now();


/*Recupération données POST*/

$action = (GETPOST('action', 'alpha') ? GETPOST('action', 'alpha') : 'view');
$cancel = GETPOST('cancel', 'alpha');
$backtopage = GETPOST('backtopage', 'alpha');
$confirm = GETPOST('confirm', 'alpha');
$socid = GETPOST('socid', 'int');

$id = GETPOST('id', 'int');

/*
AJOUTER DONNÉES
*/


if (!empty($user->socid)) $socid = $user->socid;


$form = new Form($db);
$formfile = new FormFile($db);
$formproduct = new FormProduct($db);
$formmateriel = new FormMateriel($db);
$exploitation = new Exploitation($db);
$formexploitation = new FormExploitation($db);

/*
 * Actions
 */

if ($id > 0)
{
    $result = $exploitation->fetch($id);
    if (!$result) {
        setEventMessages('Impossible de récupérer les données de l\'exploitation.', null, 'errors');
        header('Location: '.DOL_URL_ROOT.'/custom/exploitation/list.php');
        exit;
    }
} else {
    setEventMessages('Impossible de récupérer les données de l\'exploitation.', null, 'errors');
    header('Location: '.DOL_URL_ROOT.'/custom/exploitation/list.php');
}



/*
 * View
 */
llxHeader("", "Exploitation - Historique");

print '<link rel="stylesheet" type="text/css" href="'.DOL_URL_ROOT.'/custom/exploitation/css/card.css">';
$head = exploitation_prepare_head($exploitation);
$titre = 'Exploitation - Historique';
$picto = ('exploitation');
talm_fiche_head($head, 'historique', $titre, -1, $picto);

$linkback = '<a href="'.DOL_URL_ROOT.'/custom/exploitation/list.php/">Retour à la liste</a>';
talm_banner_tab($exploitation, 'id', $linkback, 1, 'rowid');

print '<div class="fichecenter">';
print '<div class="fichehalfleft">';

print '<div class="underbanner clearboth"></div>';
dol_print_object_info($exploitation, 1);
print '</div>';
print '</div>';
print '<div style="clear:both"></div>';

dol_fiche_end();



print '<br>';
print_titre('Historique du suivi');
print '<div class="div-table-responsive">';
	print '<table class="tagtable liste">'."\n";
	print '<tr class="liste_titre">';
	    print '<td>Date</td>';
	    print '<td>Utilisateur</td>';
	    print '<td>Évênement</td>';
	    print '<td>Matériel lié</td>';
	print '</tr>';

	if (!$exploitation->active) { // Affichage de la date de cloture / annulation de l'exploitation
			print '<tr class="oddeven">';
				print '<td class="tdoverflowmax200">';
				print date('d/m/Y H:i', $exploitation->date_suppression);
				print '</td>';
				print '<td class="tdoverflowmax200">';
				print $exploitation->user_suppression->getNomUrl(1, '', 0, 0, 0);
				print '</td>';
				print '<td class="tdoverflowmax200">';
				print ($exploitation->etat == 4 ? 'Clôture de l\'exploitation' : 'Annulation de l\'exploitation');
				print '</td>';
				print '<td class="tdoverflowmax200">';
				print '</td>';
			print '</tr>';
	}

	$history_data = $exploitation->getHistoric();
	foreach ($history_data as $history_row) {
      $event_date = $history_row['date_ajout'];
      $fk_localisation = $history_row['fk_localisation'];
      $fk_etat = $history_row['fk_etat'];
      $event = 'Unknown';
      $user = new User($db);
      $user->fetch($history_row['fk_user_author']);
      $materiel = new Materiel($db);
      $materiel->fetch($history_row['fk_materiel']);
      if ($fk_localisation == 1 && $fk_etat == 1) $event = "À l'entrepôt";
      elseif ($fk_localisation == 1 && $fk_etat == 2) $event = "En expédition chez l'exploitant";
      elseif ($fk_localisation == 2 && $fk_etat == 1) $event = "Confirmation de la livraison chez l'exploitant";
      elseif ($fk_localisation == 2 && $fk_etat == 2) $event = "En cours de retour à l'entrepôt";

    	print '<tr class="oddeven">';
    		print '<td class="tdoverflowmax200">';
    		print date('d/m/Y H:i', strtotime($event_date));
    		print '</td>';
    		print '<td class="tdoverflowmax200">';
    		print $user->getNomUrl(1, '', 0, 0, 0);
    		print '</td>';
    		print '<td class="tdoverflowmax200">';
    		print $event;
    		print '</td>';
    		print '<td class="tdoverflowmax200">';
    		print $materiel->getNomUrl();
    		print '</td>';
    	print '</tr>';
	}

	print '<tr class="oddeven">';
		print '<td class="tdoverflowmax200">';
		print date('d/m/Y H:i', $exploitation->date_creation);
		print '</td>';
		print '<td class="tdoverflowmax200">';
		print $exploitation->user_creation->getNomUrl(1, '', 0, 0, 0);
		print '</td>';
		print '<td class="tdoverflowmax200">';
		print 'Création de l\'exploitation';
		print '</td>';
		print '<td class="tdoverflowmax200">';
		print '</td>';
	print '</tr>';


	print '</table>';
print '</div>';




// End of page
llxFooter();
$db->close();
