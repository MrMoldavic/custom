$(document).ready(function() {
	$('.massactionselect').find('option').not(':nth-child(1)').attr('disabled', '');
	var total = $('.checkforselect:checked').length;
	if (!total) return;
	var action = $('.checkforselect:checked').first().attr('data-massaction');
	var is_same = 1;
	$('.checkforselect:checked').each(function(index) {
		if ($(this).attr('data-massaction') != action) {
			is_same = 0;
		}
	});
	if (is_same) {
		$('.massactionselect').find('option[value="' + action + '"]').removeAttr('disabled');
	}
});

$(document).on('change', '.checkforselect', function() {
	$('.massactionselect').find('option').not(':nth-child(1)').attr('disabled', '');
	var total = $('.checkforselect:checked').length;
	if (!total) return;
	var action = $('.checkforselect:checked').first().attr('data-massaction');
	var is_same = 1;
	$('.checkforselect:checked').each(function(index) {
		if ($(this).attr('data-massaction') != action) {
			is_same = 0;
		}
	});
	if (is_same) {
		$('.massactionselect').find('option[value="' + action + '"]').removeAttr('disabled');
	}
});

$(document).ready(function() {

	$(".add_select").click(function(e) {
		e.preventDefault();
		$.ajax({
			url: '/custom/exploitation/ajax/select_kit.php',
			success: function(output) {
				var output_ = '<tr><td style="text-align:right;"><div class="fas fa-angle-up mat-sort-up" style="cursor:pointer; position:absolute;"></div><div class="fas fa-angle-down mat-sort-down" style="cursor:pointer; margin-top:20px;"></div></td><td style="vertical-align:middle; padding-left:20px;"><span class="fas fa-trash delete-select"></span>' + output + '</td></tr>';
				$('[name="kit[]"]').last().closest('tr').after(output_);
				$('[name="kit[]"]').find('option:not([data-html*="badge-status8"])').removeAttr('disabled');
				$('[name="kit[]"]').each(function(index) {

					var selected = $(this).next('.select2-container').find('.select2-selection__rendered').text();
					if (!selected.trim()) {
						selected = 0;
					}
					$('[name="kit[]"]').not($(this)).find('option:contains("' + selected + '")').attr('disabled', 'disabled');
				});
				setTimeout(function() {
					var new_select = $('[name="kit[]"]').last();
					var new_width = 'calc(' + new_select.next('.select2-container').css("width") + ' + 1em)';
					new_select.next('.select2-container').css('width', new_width);
				}, 50);
			}
		});
	});

	$(document).on('click', '.delete-select', function(e) {
		console.log('delete');
		if ($('[name="kit[]"]').length > 1) {
			$(this).closest('tr').remove();

		}
	});



	var new_select = $('[name="kit[]"]').last();
	var new_width = 'calc(' + new_select.next('.select2-container').css("width") + ' + 1em)';
	new_select.next('.select2-container').css('width', new_width);
	$(document).on("click", ".mat-sort-up,.mat-sort-down", function() {
		var row = $(this).parents("tr:first");
		if ($(this).is(".mat-sort-up")) {
			if (row.prev().attr("id") != $("#first_mat").attr("id")) {
				row.insertBefore(row.prev());
			}
		} else {
			if (row.next().attr("id") != $("#select-delimitor").attr("id")) {
				row.insertAfter(row.next());
			}
		}
	});



	$(document).on('change', '[name="kit[]"]', function() {
		$('[name="kit[]"]').find('option:not([data-html*="badge-status8"])').removeAttr('disabled');
		$('[name="kit[]"]').each(function(index) {
			var selected = $(this).next('.select2-container').find('.select2-selection__rendered').text();
			if (!selected.trim()) {
				selected = 0;
			}
			console.log(selected);
			$('[name="kit[]"]').not($(this)).find('option:contains("' + selected + '")').attr('disabled', 'disabled');

		});
		var selected = $(this).next('.select2-container').find('.select2-selection__rendered').text();
		$.ajax({
			url: '/custom/exploitation/ajax/kit_status.php?id=' + $(this).find('option:contains("' + selected + '")').attr('value'),
			context: this,
			beforeSend: function() { // Before we send the request, remove the .hidden class from the spinner and default to inline-block.
				$(this).next('.select2-container').nextAll('span').remove();
				$(this).next('.select2-container').after('<span id="loader" class="lds-dual-ring"></span>');
			},
			success: function(output) {
				var output_ = output;
				$(this).next('.select2-container').nextAll('span').remove();
				$(this).next('.select2-container').after(output_);
				$($(this).next('.select2-container').nextAll('span')).tooltip({
					content: function() {
						return $(this).prop('title');
					}
				});
			}
		});
	});

	$( "#materiel-accordion" ).accordion({
		collapsible: true,
		active: 2
	});
});
