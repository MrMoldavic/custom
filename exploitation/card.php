<?php
// ini_set('display_errors', '1');
// ini_set('display_startup_errors', '1');
// error_reporting(E_ALL);

@include "../../main.inc.php";

require_once DOL_DOCUMENT_ROOT.'/core/class/html.formfile.class.php';
require_once DOL_DOCUMENT_ROOT.'/user/class/user.class.php';

require_once DOL_DOCUMENT_ROOT.'/custom/materiel/class/materiel.class.php';
require_once DOL_DOCUMENT_ROOT.'/custom/materiel/class/kit.class.php';
require_once DOL_DOCUMENT_ROOT.'/custom/materiel/class/exploitation.class.php';
require_once DOL_DOCUMENT_ROOT.'/custom/materiel/class/entretien.class.php';
require_once DOL_DOCUMENT_ROOT.'/custom/materiel/class/formmateriel.class.php';
require_once DOL_DOCUMENT_ROOT.'/custom/materiel/class/formkit.class.php';
require_once DOL_DOCUMENT_ROOT.'/custom/materiel/class/formexploitation.class.php';

require_once DOL_DOCUMENT_ROOT.'/custom/materiel/core/lib/materiel.lib.php';
require_once DOL_DOCUMENT_ROOT.'/custom/materiel/core/lib/kit.lib.php';
require_once DOL_DOCUMENT_ROOT.'/custom/materiel/core/lib/exploitation.lib.php';
require_once DOL_DOCUMENT_ROOT.'/custom/materiel/core/lib/entretien.lib.php';
require_once DOL_DOCUMENT_ROOT.'/custom/materiel/core/lib/functions.lib.php';

// Load translation files required by the page
$langs->loadLangs(array("materiel@materiel"));

// Security check
//if (! $user->rights->materiel->myobject->read) accessforbidden();
$socid = GETPOST('socid', 'int');
if (isset($user->socid) && $user->socid > 0) {
    $action = '';
    $socid = $user->socid;
}

/*Recupération données POST*/
$action = (GETPOST('action', 'alpha') ? GETPOST('action', 'alpha') : 'create');
$massaction = GETPOST('massaction', 'alpha');
$confirm = GETPOST('confirm', 'alpha');
$cancel = GETPOST('cancel', 'alpha');
$backtopage = GETPOST('backtopage', 'alpha');
$socid = GETPOST('socid', 'int');
$mode = (GETPOST('mode', 'alpha') ? GETPOST('mode', 'alpha') : 'viewkit');
$toselect = GETPOST('toselect', 'array');

$id = GETPOST('id', 'int');
$fk_materiel = GETPOST('mat_id', 'int');
$fk_materiel_echange = GETPOST('materiel_echange', 'array'); // Array avec tous les résultats des formulaire d'échange (un seul sera retenu, les autres sont égaux à -1)
$date_start = str_replace('/', '-', GETPOST('date_start')); // On remplace '/' par '-' pour que mysql comprenne le format Européen
$date_end = str_replace('/', '-', GETPOST('date_end'));
$exploitation_type_id = GETPOST('idtypeexploitation', 'int');
$fk_kit = array_values(array_diff(GETPOST('kit', 'array'), array(-1)));
$fk_exploitant = GETPOST('idexploitant', 'int');
$fk_etat_contrat = GETPOST('etat_contrat', 'int');
$notes = GETPOST('notes', 'alpha');

$fk_materiel_add = GETPOST('fk_materiel_add', 'int'); // ID du matériel à ajouter lors de l'ajout d'un matériel
$fk_kit_add = GETPOST('fk_kit_add', 'int'); // ID du kit dans lequel ajouter ce matériel


/*
AJOUTER DONNÉES
*/

if (!empty($user->socid)) $socid = $user->socid;


$form = new Form($db);
$formfile = new FormFile($db);
$formmateriel = new FormMateriel($db);
$kit = new Kit($db);
$exploitation = new Exploitation($db);
$formkit = new FormKit($db);
$formexploitation = new FormExploitation($db);

/*
 * Actions
 */

if ($cancel) $action = '';

if ($id > 0) {
    $result = $exploitation->fetch($id);
    if (!$result) {
        setEventMessages('Impossible de récupérer les données de l\'exploitation.', null, 'errors');
        header('Location: '.DOL_URL_ROOT.'/custom/exploitation/list.php');
        exit;
    }
    // if an ID is specified, replace the default action by "view"
    if ($action == 'create') $action = 'view';
}

$usercanread = ($user->rights->materiel->read);
$usercancreate = ($user->rights->materiel->create);
$usercandelete = ($user->rights->materiel->delete);

// Security check
if (!$usercanread) accessforbidden();

// Add file containing action regarding equipment follow up, exchange and maintenance 
include_once('./actions.lib.php');

/*
 * View
 */

llxHeader("", 'Exploitation');

if ($action == 'create' && !empty($exploitation_type_id) && $exploitation_type_id < 0)
{
    $exploitation_type_id = '';
    setEventMessages($langs->trans('ErrorFieldRequired', 'Type d\'exploitation'), null, 'errors');
}

if ($action == 'create' && empty($exploitation_type_id) && $usercancreate) { // SELECTION DU TYPE DE KIT
    //WYSIWYG Editor
    require_once DOL_DOCUMENT_ROOT.'/core/class/doleditor.class.php';
    
    print '<form action="'.$_SERVER["PHP_SELF"].'" method="POST">';
    print '<input type="hidden" name="token" value="'.newToken().'">';
    print '<input type="hidden" name="action" value="create">';
    print '<input type="hidden" name="type" value="'.$type.'">'."\n";
    $picto = 'exploitation';
    $title = 'Sélectionner le type d\'exploitation';

    print talm_load_fiche_titre($title, "", $picto);

    dol_fiche_head('');

    print '<table class="border centpercent">';

    print '<tr></tr>'; // Spacer


    // Type d'exploitation
    print '<tr><td class="titlefieldcreate fieldrequired">Type d\'exploitation : </td><td>';
    print $formexploitation->selectTypeExploitation();
    print '</td>';
    print '</tr>';

    print "</table>";

    dol_fiche_end();

    print '<div class="center">';
    print '<input type="submit" class="button" value="Suivant">';
    print '</div>';

    print '</form>';
} elseif ($action == 'create' && $exploitation_type_id > 0 && $usercancreate) {  // Type d'exploitation choisi -> création d'une nouvelle exploitation
    $exploitation_type_dict = $exploitation->getExploitationTypeDict();
    $exploitant_table = $exploitation->table_exploitant[GETPOST('idtypeexploitation', 'int')];
    
    //WYSIWYG Editor
    require_once DOL_DOCUMENT_ROOT.'/core/class/doleditor.class.php';

    print '<link rel="stylesheet" type="text/css" href="'.DOL_URL_ROOT.'/custom/exploitation/css/card.css">';
    print '<script src="'.DOL_URL_ROOT.'/custom/exploitation/js/exploitation.js"></script>';
    print '<form action="'.$_SERVER["PHP_SELF"].'" method="POST">';
    print '<input type="hidden" name="token" value="'.newToken().'">';
    print '<input type="hidden" name="action" value="add">';
    print '<input type="hidden" name="idtypeexploitation" value="'.GETPOST('idtypeexploitation', 'int').'">';
    print '<input type="hidden" name="type" value="'.$type.'">'."\n";
    $picto = 'exploitation';
    $title = 'Nouvelle exploitation - '. $exploitation_type_dict[$exploitation_type_id]['type'];

    print talm_load_fiche_titre($title, "", $picto);

    dol_fiche_head('');

    print '<table class="border centpercent">';

    print '<tr>';
    print '</td></tr>';

    // Date début
    print '<tr><td class="titlefieldcreate fieldrequired">Début de l\'exploitation</td><td colspan="3">';
    print $form->selectDate('', 'date_start', '', '', '', "add", 1, 1);
    print  '</td></tr>';


    // Date fin
    print '<tr><td class="titlefieldcreate fieldrequired">Fin de l\'exploitation</td><td colspan="3">';
    print $form->selectDate('', 'date_end', '', '', '', "add", 1, 1);
    print  '</td></tr>';
    print "<tr></tr>";


    // Exploitant
    print '<tr><td class="titlefieldcreate fieldrequired">Exploitant</td>
            <td colspan="3">';
    $exploitants = [];

    switch ($exploitation_type_id) {
                case '1':
                    $sqlEleve = "SELECT e.rowid,e.prenom,e.nom FROM " . MAIN_DB_PREFIX . "eleve as e";
                    $resqlEleve = $db->query($sqlEleve);

                    foreach ($resqlEleve as $val) {
                        $exploitants[$val['rowid']] = $val['prenom'] .' '.$val['nom'];
                    }
                    break;
                case '2':
                    $sqlUser = "SELECT u.rowid,u.firstname,u.lastname FROM " . MAIN_DB_PREFIX . "user as u";
                    $resqlUser = $db->query($sqlUser);

                    foreach ($resqlUser as $val) {
                        $exploitants[$val['rowid']] = $val['firstname'] .' '.$val['lastname'];
                    }
                    break;

                case '3':
                    $sqlSalle = "SELECT s.rowid,s.nom_complet FROM " . MAIN_DB_PREFIX . "salles as s";
                    $resqlSalle = $db->query($sqlSalle);

                    foreach ($resqlSalle as $val) {
                        $exploitants[$val['rowid']] = $val['nom_complet'];
                    }
                    break;
    }

    print $form->selectarray('idexploitant', $exploitants, GETPOST('idexploitant'));
    print  '</td></tr>';
    print "<tr></tr>";


    // Kit
    print '<tr></tr>';
    print '<tr id="first_mat"><td class="titlefieldcreate fieldrequired">Kit(s) à inclure : </td><td>';
    print ' <a href="" class="add_select">Cliquez pour ajouter un kit';
    print '<span class="fa fa-plus-circle valignmiddle paddingleft" title="Ajouter un kit"></span>';
    print '</a>';
    print '</td>';
    print '</tr>';

    //Ajout du premier formulaire de selection d'un kit
    print '<tr><td style="text-align:right;"><div class="fas fa-angle-up mat-sort-up" style="cursor:pointer; position:absolute;"></div><div class="fas fa-angle-down mat-sort-down" style="cursor:pointer; margin-top:20px;"></div></td><td style="vertical-align:middle; padding-left:20px;"><span class="fas fa-trash delete-select"></span>'.$formkit->selectKit('', uniqid(), 1) . '</td></tr>';
    
    print '<tr id="select-delimitor"></tr>';


    if ($exploitation_type_id == 1) { # Si le type d'exploitation est un prêt, on affiche la selection de l'état du contrat de prêt
        print '<tr><td class="titlefieldcreate fieldrequired">État du contrat</td>
                <td colspan="3">';
        $etat_contrat_array = $formexploitation->getEtatContratDict();
        print $form->selectarray('etat_contrat', $etat_contrat_array, GETPOST('etat_contrat'));
        print  '</td></tr>';
        print "<tr></tr>";
    }


    print '<tr><td class="titlefieldcreate tdtop">Notes sur l\'exploitation (facultatif)</td><td colspan="3">';

    $doleditor = new DolEditor('notes', GETPOST('notes', 'none'), '', 160, 'dolibarr_details', '', false, true, $conf->global->FCKEDITOR_ENABLE_PRODUCTDESC, ROWS_4, '90%');
    $doleditor->Create();
    print "</td></tr>";

    print "</table>";

    dol_fiche_end();

    print '<div class="center">';
    print '<input type="submit" class="button" value="'.$langs->trans("Create").'">';
    print ' &nbsp; &nbsp; ';
    print '<input type="button" class="button" value="'.$langs->trans("Cancel").'" onClick="javascript:history.go(-1)">';
    print '</div>';

    print '</form>';
} elseif ($id > 0 && $usercanread) {

    print '<script src="'.DOL_URL_ROOT.'/custom/exploitation/js/exploitation.js"></script>';
    print '<link rel="stylesheet" type="text/css" href="'.DOL_URL_ROOT.'/custom/exploitation/css/card.css">';
    $head = exploitation_prepare_head($exploitation);
    $titre = 'exploitation';
    $picto = ('exploitation');
    talm_fiche_head($head, 'card', $titre, -1, $picto);

    $linkback = '<a href="'.DOL_URL_ROOT.'/custom/exploitation/list.php/">Retour à la liste</a>';
    talm_banner_tab($exploitation, 'id', $linkback, 1, 'rowid');

    print '<div class="fichecenter">';
    print '<div class="fichehalfleft">';

    print '<div class="underbanner clearboth"></div>';
    print '<table class="border tableforfield" width="100%">';


    // Type d'exploitation
    print '<tr><td class="titlefield">';

    print "Type d'exploitation";
    print '</td><td colspan="3">';
    print $exploitation->type_exploitation;
    print '</td></tr>';


    // Kits inclus :
    $nb_materiel = 0;
    print '<tr><td class="titlefield">';
    print "Kits inclus";
    print '</td><td colspan="3">';

    foreach ($exploitation->kit_object as $kit) {
        print '<span class="badge  badge-status4 badge-status" style="color:white;">'.$kit->getNomURL(0, 'style="color:white;"').'</span> ';
        $nb_materiel+= count($kit->materiel_object);
    }

    print '</td></tr>';


    // Materiels inclus :

    print '<tr><td class="titlefield">';
    print "Matériels inclus";
    print '</td><td colspan="3">';
    print '<div id="materiel-accordion">
  <h3>'. $nb_materiel .' Matériel(s)</h3>
  <div>';
    foreach ($exploitation->kit_object as $kit) {
        foreach ($kit->materiel_object as $mat) {
            if ($mat->fk_exploitabilite == 2) {
                $is_non_fonctionnel++;
            }
            if ($mat->fk_etat == 1  && $mat->fk_exploitabilite == 1) {
                print '<span class="badge  badge-status4 badge-status" style="color:white;">'.$mat->getNomURL(0, 'style="color:white;"').'</span> ';
            } elseif ($mat->fk_etat == 2 && $mat->fk_exploitabilite == 1) {
                print '<span class="badge  badge-status2 badge-status" style="color:white;">'.$mat->getNomURL(0, 'style="color:white;"').'</span> ';
            } elseif ($mat->fk_etat == 2 && $mat->fk_exploitabilite == 2) {
                print '<span class="badge  badge-status4 badge-status" style="color:white; background-color:#905407;">'.$mat->getNomURL(0, 'style="color:white;"').'</span>&nbsp;';
            } elseif ($mat->fk_etat == 3 && $mat->fk_exploitabilite == 2) {
                print '<span class="badge  badge-status8 badge-status" style="color:white;">'.$mat->getNomURL(0, 'style="color:white;"').'</span> ';
            } else {
                print '<span class="badge  badge-status5 badge-status">'.$mat->getNomURL(0).'</span> ';
            }
        }
    }
    print '</div></div>';
    print '</td></tr>';

    // Notes
    print '<tr><td class="titlefield">';
    print "Notes";
    print '</td><td colspan="3">';
    $notes = $exploitation->notes ? $exploitation->notes : '<i>Pas de notes</i>';
    print $notes;
    print '</td></tr>';
    print '</table>';
    print '</div>';
    print '<div class="fichehalfright"><div class="ficheaddleft">';

    print '<div class="underbanner clearboth"></div>';
    print '<table class="border tableforfield" width="100%">';


    // Exploitant
    print '<tr><td class="titlefield">';

    print "Exploitant";
    print '</td><td colspan="3">';
    if($exploitation->fk_type_exploitation == 1)
    {
        $sqlExploitant = "SELECT rowid,prenom,nom FROM ".MAIN_DB_PREFIX."eleve WHERE rowid= ".$exploitation->fk_exploitant;
    }
    elseif($exploitation->fk_type_exploitation == 2)
    {
        $sqlExploitant = "SELECT rowid,firstname,lastname FROM ".MAIN_DB_PREFIX."user WHERE rowid= ".$exploitation->fk_exploitant;
    }

    $resqlExploitant = $db->query($sqlExploitant);
    $objExploitant = $db->fetch_object($resqlExploitant);

    print '<a href="'.($exploitation->fk_type_exploitation == 1 ? '/custom/viescolaire/eleve_card' : '/user/card').'.php?id='.$objExploitant->rowid.'">'.($exploitation->fk_type_exploitation == 1 ? $objExploitant->prenom.' '.$objExploitant->nom : $objExploitant->firstname.' '.$objExploitant->lastname).'</a>';

    print '</td></tr>';

    // Date début
    print '<tr><td class="titlefield">';
    print "Début";
    print '</td><td colspan="3">';
    print dol_print_date($exploitation->date_debut, '%e %B %Y');
    print '</td></tr>';

    // Date fin
    print '<tr><td class="titlefield">';
    print "Fin";
    print '</td><td colspan="3">';
    print dol_print_date($exploitation->date_fin, '%e %B %Y');
    print '</td></tr>';



    print '</table>';
    print '</div>';

    print '</div></div>';
    print '<div style="clear:both"></div>';

	printSuiviAlert($exploitation);

    print "<table class='centpercent notopnoleftnoright table-fiche-title'></table>";
    print "\n<br>\n";

    $morehtmlright = dolGetButtonTitle('Vue par kit', '', 'fa fa-th-list paddingleft imgforviewmode', $_SERVER["PHP_SELF"].'?mode=viewkit&action=view&id='.$exploitation->id, '', 1, array('morecss'=>'reposition'.($mode == 'viewmat' ? '' : ' btnTitleSelected')));
    $morehtmlright .= dolGetButtonTitle('Vue en liste', '', 'fa fa-list-alt paddingleft imgforviewmode', $_SERVER["PHP_SELF"].'?mode=viewmat&action=view&id='.$exploitation->id, '', 1, array('morecss'=>'reposition'.($mode == 'viewkit' ? '' : ' btnTitleSelected')));

    /* Affichage du suivi des matériel (seulement si l'exploitation est en cours) */
    if ($exploitation->active) {
        print '<form action="'.$_SERVER["PHP_SELF"].'" method="post" name="massaction-form">';
        print '<input type="hidden" name="id" value="'.$id.'">';
        print '<input type="hidden" name="mode" value="'.$mode.'">';
        $arrayofselected = is_array($toselect) ? $toselect : array();

        $arrayofmassactions['preexpedition'] = "<span class='fa fa-truck paddingrightonly' style='color:#666; font-size:0.86em;'></span>Livrer chez l'exploitant";
        $arrayofmassactions['preshipping'] = "<span class='fa fa-dolly paddingrightonly' style='color:#666; font-size:0.86em;'></span>Confirmer la livraison";
        $arrayofmassactions['pretoreturn'] = "<span class='fa fa-truck paddingrightonly' style='color:#666; font-size:0.86em;'></span>Retour à l'entrepôt";
        $arrayofmassactions['prereturn'] = "<span class='fa fa-warehouse paddingrightonly' style='color:#666; font-size:0.86em;'></span>Confirmer le retour";

        print '<script src="'.DOL_URL_ROOT.'/custom/exploitation/js/exploitation.js"></script>';
        $massactionbutton = $form->selectMassAction($massaction, $arrayofmassactions);

        print talm_load_fiche_titre('Suivi des matériels', $morehtmlright, 'materiel', 0, '', '', $massactionbutton);
        // Gestion des actions de masse
        require_once DOL_DOCUMENT_ROOT.'/custom/materiel/core/lib/exploitation_massactions_pre.php';

        if ($mode == 'viewkit' && $exploitation->active) {
            foreach ($exploitation->kit_object as $kit) {
                $kit_link = '<a href="'.DOL_URL_ROOT.'/custom/kit/card.php?id='.$kit->id.'" style="color:rgb(0, 123, 140);">'.$kit->ref.'</a>';
                print_titre($kit_link);

                print '<div class="fichecenter">';

                // Lines with input filters
                print '<div class="div-table-responsive">';
                print '<table class="tagtable liste">'."\n";
                print '<tr class="liste_titre">';

                print_liste_field_titre('Réf.');
                print_liste_field_titre('Localisation');
                print_liste_field_titre('Action', "", "", "", "", 'align="center"');
                print '<th>';	// Action
                print '<td class="nowrap center">';
                print $form->showCheckAddButtons($kit->ref, 1);
                print '</td>';
                print '</th>';


                foreach ($kit->materiel_object as $mat) {
                    $status = getMaterielSuiviStatus($mat->id);
                    $is_exchange = $status['is_exchange'];
                    $is_entretien = isMaterielInEntretien($mat->id);
                    $is_replacement = isMaterielReplacement($mat->id);

                    print '<tr class="oddeven" id="mat'. $mat->id .'">'; // Ajout d'un id unique par ligne pour permettre le retour à cette ligne après le chargement de la page
                    print '<td class="tdoverflowmax200">';
                    print $mat->getNomUrl();
                    print "</td>\n";

                    print '<td class="tdoverflowmax200">';
                    printMaterielSuiviStatus($mat->id, $exploitation);
                    print "</td>\n";

                    print '<td class="center">';
                    printMaterielActions($mat->id, $exploitation);
                    print "</td>\n";

                    print '<td class="tdoverflowmax200">';
                    print "</td>\n";

                    // Action
                    print '<td class="nowrap center">';
                    if ($usercandelete) {
                        $selected = 0;
                        if (in_array($mat->id, $arrayofselected)) {
                            $selected = 1;
                        }
                        print '<input id="cb'.$mat->id.'" class="flat checkforselect '. $kit->ref .'" type="checkbox" name="toselect[]" data-massaction="'. getMassactionValue($mat->id) .'" value="'.$mat->id.'"'.($selected ? ' checked="checked"' : '').'>';
                    }

                    print '</td>';
                    print '</tr>';
                }

                print "</table><br>";


                print '</div>';
            }
        } elseif ($mode == 'viewmat') {
            print '<div class="fichecenter">';

            // Lines with input filters
            print '<div class="div-table-responsive">';
            print '<table class="tagtable liste">'."\n";
            print '<tr class="liste_titre">';

            print_liste_field_titre('Réf.');
            print_liste_field_titre('Kit');
            print_liste_field_titre('Localisation');
            print_liste_field_titre('Action', "", "", "", "", 'align="center"');
            print '<th>';	// Action
            print '<td class="nowrap center">';
            print $form->showCheckAddButtons('checkforselect', 1);
            print '</td>';
            print '</th>';


            foreach ($exploitation->kit_object as $kit) {
                foreach ($kit->materiel_object as $mat) {
                    $status = getMaterielSuiviStatus($mat->id);
                    $is_exchange = $status['is_exchange'];
                    $is_entretien = isMaterielInEntretien($mat->id);
                    $is_replacement = isMaterielReplacement($mat->id);
                    $row_color = ($is_exchange || $is_entretien ? 'style="background-color:bisque;"' : '');
                    if ($is_replacement) $row_color = 'style="background-color:honeydew;"';
                    print '<tr class="oddeven">';
                    print '<td class="tdoverflowmax200">';
                    print $mat->getNomUrl();
                    print "</td>\n";

                    print '<td class="tdoverflowmax200">';
                    print $kit->getNomUrl();
                    print "</td>\n";

                    print '<td class="tdoverflowmax200">';
                    printMaterielSuiviStatus($mat->id, $exploitation);
                    print "</td>\n";

                    print '<td class="center">';
                    printMaterielActions($mat->id, $exploitation, '&mode=viewmat');
                    print "</td>\n";

                    print '<td class="tdoverflowmax200">';
                    print "</td>\n";

                    // Action
                    print '<td class="nowrap center">';
                    $selected = 0;
                    if (in_array($mat->id, $arrayofselected)) {
                        $selected = 1;
                    }
                    print '<input id="cb'.$mat->id.'" class="flat checkforselect" type="checkbox" name="toselect[]" data-massaction="'. getMassactionValue($mat->id) .'" value="'.$mat->id.'"'.($selected ? ' checked="checked"' : '').'>';
                    print '</td>';
                    print '</tr>';
                }
            }
            print "</table><br>";


            print '</div>';
        }
    }

    print '</form>';


    dol_fiche_end();
} elseif ($action != 'create') {
    exit;
}

// End of page
llxFooter();
$db->close();
