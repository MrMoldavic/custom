<?php
/*
 *  Charge la liste et l'état des kits inclus dans l'exploitation donnée
 */

// Load Dolibarr environment
$res = 0;
// Try main.inc.php into web root known defined into CONTEXT_DOCUMENT_ROOT (not always defined)
if (!$res && !empty($_SERVER["CONTEXT_DOCUMENT_ROOT"])) $res = @include $_SERVER["CONTEXT_DOCUMENT_ROOT"]."/main.inc.php";
// Try main.inc.php into web root detected using web root calculated from SCRIPT_FILENAME
$tmp = empty($_SERVER['SCRIPT_FILENAME']) ? '' : $_SERVER['SCRIPT_FILENAME']; $tmp2 = realpath(__FILE__); $i = strlen($tmp) - 1; $j = strlen($tmp2) - 1;
while ($i > 0 && $j > 0 && isset($tmp[$i]) && isset($tmp2[$j]) && $tmp[$i] == $tmp2[$j]) { $i--; $j--; }
if (!$res && $i > 0 && file_exists(substr($tmp, 0, ($i + 1))."/main.inc.php")) $res = @include substr($tmp, 0, ($i + 1))."/main.inc.php";
if (!$res && $i > 0 && file_exists(dirname(substr($tmp, 0, ($i + 1)))."/main.inc.php")) $res = @include dirname(substr($tmp, 0, ($i + 1)))."/main.inc.php";
// Try main.inc.php using relative path
if (!$res && file_exists("../main.inc.php")) $res = @include "../main.inc.php";
if (!$res && file_exists("../../main.inc.php")) $res = @include "../../main.inc.php";
if (!$res && file_exists("../../../main.inc.php")) $res = @include "../../../main.inc.php";
if (!$res) die("Include of main fails");

require_once DOL_DOCUMENT_ROOT.'/custom/materiel/class/kit.class.php';
$kit = new Kit($db);
$kit->fetch(GETPOST('id', 'int'));
				
$mat_object_sorted = $kit->materiel_object;
$is_non_fonctionnel = 0; //on regarde si un des matériels est non fonctionnel pour afficher une alerte
usort($mat_object_sorted, function($a, $b) {return strcmp($a->fk_etat+$a->fk_exploitabilite, $b->fk_etat+$b->fk_exploitabilite);}); // ON TRIE LES MATERIELS SELON L'ÉTAT
foreach ($mat_object_sorted as $mat) {
    if ($mat->fk_exploitabilite == 2) $is_non_fonctionnel++;
    if ($mat->fk_etat == 1  && $mat->fk_exploitabilite == 1) print '<span class="badge  badge-status4 badge-status" style="color:white;">'.$mat->getNomURL(0, 'style="color:white;"').'</span> ';
    elseif ($mat->fk_etat == 2 && $mat->fk_exploitabilite == 1) print '<span class="badge  badge-status2 badge-status" style="color:white;">'.$mat->getNomURL(0, 'style="color:white;"').'</span> ';
    elseif ($mat->fk_etat == 2 && $mat->fk_exploitabilite == 2) print '<span class="badge  badge-status4 badge-status" style="color:white; background-color:#905407;">'.$mat->getNomURL(0, 'style="color:white;"').'</span>&nbsp;';
    elseif ($mat->fk_etat == 3 && $mat->fk_exploitabilite == 2) print '<span class="badge  badge-status8 badge-status" style="color:white;">'.$mat->getNomURL(0, 'style="color:white;"').'</span> ';
    else print '<span class="badge  badge-status5 badge-status">'.$mat->getNomURL(0).'</span> ';
}
?>